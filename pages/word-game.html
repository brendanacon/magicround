<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Word Game</title>
    <link rel="stylesheet" href="../css/word-game.css">
</head>
<body>
    <main class="app-shell">
        <header class="app-header">
            <h1 class="app-title">Secret Word Game</h1>
            <p class="app-subtitle">Activate players, draw a word, and keep score as the night unfolds.</p>
        </header>

        <section class="tab-bar" role="tablist">
            <button class="tab-button active" data-tab="players" role="tab" aria-selected="true">Players</button>
            <button class="tab-button" data-tab="play" role="tab" aria-selected="false">Play</button>
            <button class="tab-button" data-tab="leaderboard" role="tab" aria-selected="false">Leaderboard</button>
            <button class="tab-button" data-tab="words" role="tab" aria-selected="false">Word Bank</button>
        </section>

        <section class="panel active" id="tab-players" role="tabpanel">
            <div class="card">
                <h2 class="section-title">Celebrities in the game</h2>
                <div class="player-grid" id="playerGrid"></div>
            </div>
        </section>

        <section class="panel" id="tab-play" role="tabpanel">
            <div class="card play-layout">
                <div class="active-player">
                    <img class="player-avatar" id="activeAvatar" alt="Selected player avatar">
                    <div>
                        <div class="player-name" id="activeName">Select an active player</div>
                        <div class="word-chip" id="activeWord">No word assigned yet.</div>
                    </div>
                    <div class="action-row">
                        <button class="button" id="nextPlayer">Next player</button>
                        <button class="button ghost" id="clearWord">Clear word</button>
                    </div>
                </div>

                <div class="slot-machine">
                    <div class="slot-window" id="slotWindow">Ready</div>
                    <button class="button" id="spinLever">Pull the lever</button>
                    <div class="status-text" id="spinStatus"></div>
                </div>

                <div class="action-row">
                    <button class="button" id="successPoint">Word landed (+1)</button>
                    <button class="button secondary" id="caughtPoint">Called out (-1)</button>
                </div>
            </div>
        </section>

        <section class="panel" id="tab-leaderboard" role="tabpanel">
            <div class="card">
                <h2 class="section-title">Leaderboard</h2>
                <div class="leaderboard-list" id="leaderboardList"></div>
                <button class="button secondary" id="resetScores">Reset scores</button>
            </div>
        </section>

        <section class="panel" id="tab-words" role="tabpanel">
            <div class="card">
                <h2 class="section-title">Word Bank</h2>
                <p class="app-subtitle">Add one word per line. Save to update the slot machine.</p>
                <div class="word-bank">
                    <textarea id="wordBankInput" placeholder="blue\nred\ncoffee\ndessert"></textarea>
                    <button class="button" id="saveWords">Save words</button>
                </div>
            </div>
        </section>

        <nav class="app-nav">
            <a href="../index.html">Magic Round Home</a>
            <a href="spin-wheel.html">Spin the Wheel</a>
            <a href="see-it-sip-it.html">See it, Sip it</a>
            <a href="fun-facts.html">Fun Facts</a>
        </nav>
    </main>

    <script>
        const defaultPlayers = [
            { id: 'rdj', name: 'Robert Downey Jr.' },
            { id: 'sj', name: 'Scarlett Johansson' },
            { id: 'ch', name: 'Chris Hemsworth' },
            { id: 'zd', name: 'Zendaya' },
            { id: 'dj', name: 'Dwayne Johnson' },
            { id: 'jl', name: 'Jennifer Lawrence' },
            { id: 'th', name: 'Tom Holland' },
            { id: 'gg', name: 'Gal Gadot' },
            { id: 'rr', name: 'Ryan Reynolds' },
            { id: 'es', name: 'Emma Stone' },
            { id: 'kr', name: 'Keanu Reeves' },
            { id: 'ts', name: 'Taylor Swift' },
            { id: 'by', name: 'Beyoncé' },
            { id: 'ce', name: 'Chris Evans' }
        ];

        const defaultWords = [
            'blue', 'red', 'coffee', 'dessert', 'holiday', 'sunset', 'passport',
            'lantern', 'ocean', 'movie', 'stadium', 'music', 'jacket', 'dessert'
        ];

        const colors = ['#ff9f9f', '#ffd699', '#9ecbff', '#a8e6cf', '#c7a6ff', '#f5b7ff'];

        const playerGrid = document.getElementById('playerGrid');
        const leaderboardList = document.getElementById('leaderboardList');
        const slotWindow = document.getElementById('slotWindow');
        const spinStatus = document.getElementById('spinStatus');
        const activeAvatar = document.getElementById('activeAvatar');
        const activeName = document.getElementById('activeName');
        const activeWord = document.getElementById('activeWord');
        const wordBankInput = document.getElementById('wordBankInput');

        let players = loadPlayers();
        let words = loadWords();
        let activePlayerId = localStorage.getItem('magicroundActivePlayerId') || '';
        let spinTimer = null;

        function loadPlayers() {
            const stored = localStorage.getItem('magicroundPlayers');
            if (stored) {
                return JSON.parse(stored);
            }
            return defaultPlayers.map((player, index) => ({
                ...player,
                active: index < 6,
                score: 0,
                currentWord: ''
            }));
        }

        function savePlayers() {
            localStorage.setItem('magicroundPlayers', JSON.stringify(players));
        }

        function loadWords() {
            const stored = localStorage.getItem('magicroundWords');
            return stored ? JSON.parse(stored) : defaultWords;
        }

        function saveWords() {
            localStorage.setItem('magicroundWords', JSON.stringify(words));
        }

        function initialsFromName(name) {
            return name.split(' ').map(part => part[0]).slice(0, 2).join('').toUpperCase();
        }

        function createAvatar(name, index) {
            const color = colors[index % colors.length];
            const initials = initialsFromName(name);
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120">
                    <defs>
                        <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="${color}" />
                            <stop offset="100%" stop-color="#ffffff" />
                        </linearGradient>
                    </defs>
                    <rect width="120" height="120" rx="24" fill="url(#grad)" />
                    <text x="50%" y="55%" text-anchor="middle" fill="#111" font-family="Arial" font-size="44" font-weight="bold">${initials}</text>
                </svg>
            `;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function setActivePlayer(id) {
            activePlayerId = id;
            localStorage.setItem('magicroundActivePlayerId', id);
            renderActivePlayer();
        }

        function getActivePlayers() {
            return players.filter(player => player.active);
        }

        function nextActivePlayer() {
            const activePlayers = getActivePlayers();
            if (activePlayers.length === 0) {
                setActivePlayer('');
                return;
            }
            const currentIndex = activePlayers.findIndex(player => player.id === activePlayerId);
            const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % activePlayers.length;
            setActivePlayer(activePlayers[nextIndex].id);
        }

        function spinWord() {
            const activePlayer = players.find(player => player.id === activePlayerId);
            if (!activePlayer) {
                spinStatus.textContent = 'Activate someone first in the Players tab.';
                return;
            }
            if (words.length === 0) {
                spinStatus.textContent = 'Add some words in the Word Bank first.';
                return;
            }
            spinStatus.textContent = 'Spinning...';
            slotWindow.classList.add('spinning');
            let ticks = 0;
            if (spinTimer) {
                clearInterval(spinTimer);
            }
            spinTimer = setInterval(() => {
                ticks += 1;
                slotWindow.textContent = words[Math.floor(Math.random() * words.length)];
                if (ticks > 15) {
                    clearInterval(spinTimer);
                    const chosen = words[Math.floor(Math.random() * words.length)];
                    activePlayer.currentWord = chosen;
                    slotWindow.textContent = chosen;
                    slotWindow.classList.remove('spinning');
                    spinStatus.textContent = `${activePlayer.name} must drop “${chosen}” into conversation.`;
                    savePlayers();
                    renderActivePlayer();
                    renderPlayers();
                }
            }, 120);
        }

        function updateScore(id, delta) {
            const player = players.find(item => item.id === id);
            if (!player) {
                return;
            }
            player.score += delta;
            savePlayers();
            renderPlayers();
            renderLeaderboard();
            renderActivePlayer();
        }

        function clearWord(id) {
            const player = players.find(item => item.id === id);
            if (!player) {
                return;
            }
            player.currentWord = '';
            savePlayers();
            renderPlayers();
            renderActivePlayer();
            spinStatus.textContent = 'Word cleared. Ready for a new spin.';
        }

        function renderPlayers() {
            playerGrid.innerHTML = '';
            players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';

                const header = document.createElement('div');
                header.className = 'player-header';

                const avatar = document.createElement('img');
                avatar.className = 'player-avatar';
                avatar.src = createAvatar(player.name, index);
                avatar.alt = `${player.name} avatar`;

                const info = document.createElement('div');
                info.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-meta">Score: ${player.score}</div>
                    <div class="player-meta">Word: ${player.currentWord || 'None yet'}</div>
                `;

                header.appendChild(avatar);
                header.appendChild(info);

                const toggleRow = document.createElement('label');
                toggleRow.className = 'toggle-row';
                toggleRow.innerHTML = `
                    <span>Active in game</span>
                    <input type="checkbox" ${player.active ? 'checked' : ''}>
                `;

                const toggleInput = toggleRow.querySelector('input');
                toggleInput.addEventListener('change', () => {
                    player.active = toggleInput.checked;
                    savePlayers();
                    renderActivePlayer();
                    renderLeaderboard();
                });

                const actions = document.createElement('div');
                actions.className = 'action-row';
                actions.innerHTML = `
                    <button class="button">+1 Point</button>
                    <button class="button secondary">-1 Point</button>
                `;
                const [plusButton, minusButton] = actions.querySelectorAll('button');
                plusButton.addEventListener('click', () => updateScore(player.id, 1));
                minusButton.addEventListener('click', () => updateScore(player.id, -1));

                card.appendChild(header);
                card.appendChild(toggleRow);
                card.appendChild(actions);
                playerGrid.appendChild(card);
            });
        }

        function renderActivePlayer() {
            const activePlayer = players.find(player => player.id === activePlayerId && player.active);
            if (!activePlayer) {
                activeName.textContent = 'Select an active player';
                activeWord.textContent = 'No word assigned yet.';
                activeAvatar.src = createAvatar('?', 0);
                return;
            }
            activeName.textContent = activePlayer.name;
            activeWord.textContent = activePlayer.currentWord
                ? `Current word: “${activePlayer.currentWord}”`
                : 'No word assigned yet.';
            const index = players.findIndex(player => player.id === activePlayer.id);
            activeAvatar.src = createAvatar(activePlayer.name, index);
        }

        function renderLeaderboard() {
            const sorted = [...players].sort((a, b) => b.score - a.score);
            leaderboardList.innerHTML = '';
            sorted.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <span>#${index + 1} ${player.name}</span>
                    <span>${player.score} pts</span>
                `;
                leaderboardList.appendChild(item);
            });
        }

        function setupTabs() {
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    buttons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    button.classList.add('active');
                    button.setAttribute('aria-selected', 'true');
                    const tabId = button.getAttribute('data-tab');
                    document.querySelectorAll('.panel').forEach(panel => {
                        panel.classList.toggle('active', panel.id === `tab-${tabId}`);
                    });
                });
            });
        }

        function setupControls() {
            document.getElementById('nextPlayer').addEventListener('click', () => {
                nextActivePlayer();
            });

            document.getElementById('spinLever').addEventListener('click', spinWord);

            document.getElementById('successPoint').addEventListener('click', () => {
                if (!activePlayerId) {
                    spinStatus.textContent = 'Pick an active player first.';
                    return;
                }
                updateScore(activePlayerId, 1);
                clearWord(activePlayerId);
            });

            document.getElementById('caughtPoint').addEventListener('click', () => {
                if (!activePlayerId) {
                    spinStatus.textContent = 'Pick an active player first.';
                    return;
                }
                updateScore(activePlayerId, -1);
                clearWord(activePlayerId);
            });

            document.getElementById('clearWord').addEventListener('click', () => {
                if (!activePlayerId) {
                    spinStatus.textContent = 'Pick an active player first.';
                    return;
                }
                clearWord(activePlayerId);
            });

            document.getElementById('resetScores').addEventListener('click', () => {
                players = players.map(player => ({ ...player, score: 0 }));
                savePlayers();
                renderPlayers();
                renderLeaderboard();
                renderActivePlayer();
            });

            document.getElementById('saveWords').addEventListener('click', () => {
                const input = wordBankInput.value
                    .split('\n')
                    .map(word => word.trim())
                    .filter(Boolean);
                words = input;
                saveWords();
                spinStatus.textContent = `Saved ${words.length} words.`;
            });
        }

        function init() {
            wordBankInput.value = words.join('\n');
            renderPlayers();
            renderLeaderboard();
            renderActivePlayer();
            setupTabs();
            setupControls();
            if (activePlayerId) {
                renderActivePlayer();
            } else {
                nextActivePlayer();
            }
        }

        init();
    </script>
</body>
</html>
