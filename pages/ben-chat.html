<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Ben Thompson</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            min-height: 100vh;
        }

        .page-wrapper {
            max-width: 720px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Profile Header --- */
        .profile-header {
            text-align: center;
            padding: 48px 0 32px;
        }

        .avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            margin: 0 auto 20px;
            letter-spacing: 1px;
        }

        .profile-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .profile-header .tagline {
            font-size: 15px;
            color: #666;
            max-width: 400px;
            margin: 0 auto 16px;
            line-height: 1.5;
        }

        .feed-status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            color: #555;
        }

        .feed-status-pill .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .feed-status-pill .status-dot.loaded { background: #22c55e; }
        .feed-status-pill .status-dot.empty { background: #ef4444; }
        .feed-status-pill .status-dot.loading {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* --- Feed Actions --- */
        .feed-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 14px;
        }

        .feed-btn {
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.15s;
        }

        .feed-btn:hover {
            background: #f5f5f5;
            border-color: #bbb;
        }

        .feed-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .feed-btn.primary {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        .feed-btn.primary:hover {
            background: #333;
        }

        /* --- Setup Panel --- */
        .setup-panel {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            display: none;
        }

        .setup-panel.visible { display: block; }

        .setup-panel h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .setup-panel label {
            color: #555;
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .setup-panel input[type="url"] {
            width: 100%;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 12px;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 8px;
            outline: none;
            transition: border-color 0.15s;
        }

        .setup-panel input[type="url"]:focus {
            border-color: #4F46E5;
        }

        .setup-panel .hint {
            color: #999;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .setup-panel hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        .setup-panel textarea {
            width: 100%;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 12px;
            color: #1a1a1a;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            resize: vertical;
            outline: none;
        }

        .setup-panel textarea:focus {
            border-color: #4F46E5;
        }

        /* --- Chat Window --- */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-window {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            height: 420px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 16px;
            scroll-behavior: smooth;
        }

        .chat-window::-webkit-scrollbar {
            width: 6px;
        }

        .chat-window::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-window::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .chat-message {
            margin-bottom: 16px;
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            text-align: right;
        }

        .chat-message.user .msg-bubble {
            background: #1a1a1a;
            display: inline-block;
            text-align: left;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px 16px 4px 16px;
            color: #fff;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.ben .msg-bubble {
            background: #f5f5f5;
            display: inline-block;
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px 16px 16px 4px;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.6;
        }

        .chat-message .msg-sender {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            opacity: 0.5;
            color: #666;
        }

        .chat-message.user .msg-sender { color: #999; }
        .chat-message.ben .msg-sender { color: #666; }

        .msg-bubble .article-ref {
            display: block;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 12px;
            color: #888;
        }

        .msg-bubble .article-title {
            color: #4F46E5;
            font-weight: 600;
        }

        .msg-bubble .article-date {
            color: #999;
            font-size: 12px;
        }

        .msg-bubble .excerpt {
            margin-top: 6px;
            line-height: 1.6;
            font-size: 14px;
        }

        .msg-bubble .excerpt mark {
            background: rgba(79, 70, 229, 0.12);
            color: #4F46E5;
            border-radius: 2px;
            padding: 0 2px;
        }

        /* --- Chat Input --- */
        .chat-input-wrapper {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
            transition: border-color 0.15s;
        }

        .chat-input-wrapper:focus-within {
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
        }

        .chat-input-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 15px;
            outline: none;
        }

        .chat-input::placeholder {
            color: #aaa;
        }

        .send-btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .send-btn:hover { background: #4338CA; }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Topic Chips --- */
        .topic-chips {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            padding: 0 0 32px;
        }

        .topic-chip {
            background: #fff;
            border: 1px solid #e0e0e0;
            color: #444;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            font-weight: 500;
        }

        .topic-chip:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        /* --- How it works --- */
        .how-it-works {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            color: #555;
            font-size: 13px;
            line-height: 1.6;
        }

        .how-it-works summary {
            color: #1a1a1a;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .how-it-works ul {
            margin: 10px 0 0;
            padding-left: 20px;
        }

        .how-it-works li {
            margin: 5px 0;
        }

        .articles-count {
            color: #4F46E5;
            font-weight: 600;
        }

        /* --- Responsive --- */
        @media (max-width: 640px) {
            .profile-header {
                padding: 32px 0 24px;
            }

            .profile-header h1 {
                font-size: 24px;
            }

            .chat-window {
                height: 320px;
            }

            .chat-message.user .msg-bubble,
            .chat-message.ben .msg-bubble {
                max-width: 92%;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="avatar">BT</div>
            <h1>Ben Thompson</h1>
            <p class="tagline">Sharp analysis on tech strategy, platforms, and the business of technology</p>
            <div class="feed-status-pill">
                <span class="status-dot empty" id="statusDot"></span>
                <span id="statusText">No feed loaded</span>
                <span id="articleCount"></span>
            </div>
            <div class="feed-actions">
                <button class="feed-btn primary" id="refreshBtn" onclick="refreshFeed()">Refresh Feed</button>
                <button class="feed-btn" id="settingsBtn" onclick="toggleSetup()">Settings</button>
            </div>
        </div>

        <!-- Setup panel -->
        <div class="setup-panel" id="setupPanel">
            <h3>Feed Setup</h3>
            <label for="feedUrl">Stratechery RSS Feed URL</label>
            <input type="url" id="feedUrl" placeholder="https://stratechery.passport.online/feed/rss/..." />
            <p class="hint">Your personal subscriber RSS URL from Stratechery. Stored locally in your browser only.</p>
            <button class="feed-btn primary" onclick="saveFeedUrl()">Save & Fetch</button>

            <hr>
            <h3>Manual Paste</h3>
            <label for="pasteXml">Paste RSS XML here</label>
            <textarea id="pasteXml" rows="6" placeholder="Open the RSS URL in your browser, Select All, Copy, then paste here..."></textarea>
            <p class="hint">Open your RSS feed URL directly in your browser, copy the page content (Ctrl+A, Ctrl+C), and paste it above.</p>
            <button class="feed-btn primary" onclick="loadPastedFeed()">Load Pasted Feed</button>
        </div>

        <div class="chat-section">
            <details class="how-it-works">
                <summary>How does this work?</summary>
                <ul>
                    <li>This page fetches Ben Thompson's Stratechery RSS feed and caches it locally in your browser.</li>
                    <li>When you ask a question, it searches through the cached articles to find relevant passages.</li>
                    <li>Responses are actual excerpts from Ben's writing &mdash; his real words and views.</li>
                    <li>Your RSS feed URL and all data stays in your browser only &mdash; nothing is sent to any server.</li>
                </ul>
            </details>

            <!-- Chat window -->
            <div class="chat-window" id="chatWindow">
                <div class="chat-message ben">
                    <div class="msg-sender">Stratechery</div>
                    <div class="msg-bubble">
                        Welcome! I'll search through Ben Thompson's Stratechery articles to answer your questions using his actual words and analysis.
                        <br><br>
                        Load the RSS feed using the Refresh button above, then ask me anything about tech, strategy, AI, platforms, or whatever Ben has been writing about.
                    </div>
                </div>
            </div>

            <!-- Input area -->
            <div class="chat-input-wrapper">
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask Ben anything..."
                           onkeydown="if(event.key==='Enter')sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">Ask</button>
                </div>
            </div>

            <!-- Suggested topics -->
            <div class="topic-chips" id="topicChips">
                <button class="topic-chip" onclick="askQuestion(this.textContent)">What does Ben think about AI?</button>
                <button class="topic-chip" onclick="askQuestion(this.textContent)">Apple's strategy</button>
                <button class="topic-chip" onclick="askQuestion(this.textContent)">Google and antitrust</button>
                <button class="topic-chip" onclick="askQuestion(this.textContent)">Aggregation theory</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // --- Constants ---
        const CACHE_KEY = 'ben-chat-feed-cache';
        const URL_KEY = 'ben-chat-feed-url';
        const LAST_FETCH_KEY = 'ben-chat-last-fetch';
        const CACHE_TTL = 6 * 60 * 60 * 1000;       // 6 hours
        const REFRESH_COOLDOWN = 5 * 60 * 1000;        // 5 minutes
        const DEFAULT_FEED_URL = 'https://stratechery.passport.online/feed/rss/CKPS49J7qPJbN4eYcQDpR';
        const CORS_PROXIES = [
            { name: 'cf-worker', url: url => 'https://rss-proxy.brendanaconnaughton.workers.dev/?url=' + encodeURIComponent(url), json: false },
            { name: 'allorigins-json', url: url => 'https://api.allorigins.win/get?url=' + encodeURIComponent(url), json: true },
            { name: 'allorigins-raw', url: url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url), json: false },
            { name: 'corsproxy', url: url => 'https://corsproxy.io/?' + encodeURIComponent(url), json: false },
            { name: 'rss2json', url: url => 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(url), rss2json: true },
        ];

        // Stop words for search
        const STOP_WORDS = new Set([
            'a','an','the','is','are','was','were','be','been','being',
            'have','has','had','do','does','did','will','would','could',
            'should','may','might','shall','can','need','dare','ought',
            'used','to','of','in','for','on','with','at','by','from',
            'as','into','through','during','before','after','above',
            'below','between','out','off','over','under','again',
            'further','then','once','here','there','when','where',
            'why','how','all','both','each','few','more','most',
            'other','some','such','no','nor','not','only','own',
            'same','so','than','too','very','just','because','but',
            'and','or','if','while','about','up','what','which',
            'who','whom','this','that','these','those','am','i',
            'me','my','we','our','you','your','he','him','his',
            'she','her','it','its','they','them','their','ben',
            'thompson','think','does','say','said','like','also',
            'really','much','many','get','got','make','thing','things',
            'going','know','dont','want','way','one','well'
        ]);

        let articles = [];

        // --- DOM refs ---
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const articleCount = document.getElementById('articleCount');
        const setupPanel = document.getElementById('setupPanel');
        const feedUrlInput = document.getElementById('feedUrl');
        const refreshBtn = document.getElementById('refreshBtn');
        const topicChips = document.getElementById('topicChips');

        // --- Init ---
        function init() {
            // Set default URL if none saved
            if (!localStorage.getItem(URL_KEY)) {
                localStorage.setItem(URL_KEY, DEFAULT_FEED_URL);
            }

            const savedUrl = localStorage.getItem(URL_KEY);
            feedUrlInput.value = savedUrl;

            // Try loading cached feed
            const cached = loadCache();
            if (cached && cached.length > 0) {
                articles = cached;
                updateStatus('loaded', articles.length + ' articles cached', articles.length);
                buildTopicChips();
            } else {
                updateStatus('empty', 'Click Refresh to load the feed');
            }

            updateRefreshButton();
        }

        // --- Cache ---
        function loadCache() {
            try {
                const raw = localStorage.getItem(CACHE_KEY);
                if (!raw) return null;
                const data = JSON.parse(raw);
                return data.articles || null;
            } catch(e) {
                return null;
            }
        }

        function saveCache(arts) {
            localStorage.setItem(CACHE_KEY, JSON.stringify({ articles: arts }));
            localStorage.setItem(LAST_FETCH_KEY, Date.now().toString());
        }

        function getCacheAge() {
            const last = parseInt(localStorage.getItem(LAST_FETCH_KEY) || '0');
            return Date.now() - last;
        }

        function isCacheValid() {
            return getCacheAge() < CACHE_TTL;
        }

        function canRefresh() {
            return getCacheAge() >= REFRESH_COOLDOWN;
        }

        function updateRefreshButton() {
            const age = getCacheAge();
            if (age < REFRESH_COOLDOWN) {
                const remaining = Math.ceil((REFRESH_COOLDOWN - age) / 60000);
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Cooldown: ' + remaining + 'm';
                setTimeout(updateRefreshButton, 60000);
            } else {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Feed';
            }
        }

        // --- Status ---
        function updateStatus(state, text, count) {
            statusDot.className = 'status-dot ' + state;
            statusText.textContent = text;
            if (count !== undefined) {
                articleCount.textContent = ' (' + count + ' articles)';
            } else {
                articleCount.textContent = '';
            }
        }

        // --- Setup ---
        window.toggleSetup = function() {
            setupPanel.classList.toggle('visible');
        };

        window.saveFeedUrl = function() {
            const url = feedUrlInput.value.trim();
            if (!url) return;
            localStorage.setItem(URL_KEY, url);
            setupPanel.classList.remove('visible');
            refreshFeed();
        };

        // --- Fetch RSS ---
        window.refreshFeed = async function() {
            const feedUrl = localStorage.getItem(URL_KEY);
            if (!feedUrl) {
                setupPanel.classList.add('visible');
                addBenMessage('Please set your Stratechery RSS feed URL in Settings first.');
                return;
            }

            if (!canRefresh() && articles.length > 0) {
                addBenMessage('Feed was refreshed recently. Please wait for the cooldown to expire.');
                return;
            }

            updateStatus('loading', 'Fetching feed...');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Fetching...';

            const errors = [];

            // Try each CORS proxy
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxy = CORS_PROXIES[i];
                try {
                    const proxyUrl = proxy.url(feedUrl);
                    updateStatus('loading', 'Trying ' + proxy.name + '...');

                    const resp = await fetch(proxyUrl, {
                        headers: { 'Accept': 'application/rss+xml, application/xml, text/xml, application/json, */*' }
                    });

                    if (!resp.ok) {
                        let body = '';
                        try { body = (await resp.text()).substring(0, 120); } catch(ignored) {}
                        errors.push(proxy.name + ': HTTP ' + resp.status + ' ' + resp.statusText + (body ? ' â€” ' + body : ''));
                        continue;
                    }

                    // rss2json returns JSON with parsed items
                    if (proxy.rss2json) {
                        const json = await resp.json();
                        if (json.status === 'ok' && json.items && json.items.length > 0) {
                            articles = parseRSS2JSON(json);
                            if (articles.length > 0) {
                                saveCache(articles);
                                updateStatus('loaded', 'Feed loaded via ' + proxy.name, articles.length);
                                updateRefreshButton();
                                buildTopicChips();
                                addBenMessage('Feed loaded with ' + articles.length + ' articles! Ask me anything about what Ben has been writing about.');
                                return;
                            }
                        }
                        errors.push(proxy.name + ': ' + (json.message || 'no items'));
                        continue;
                    }

                    // allorigins JSON wraps content in {contents: "..."}
                    let xml;
                    if (proxy.json) {
                        const json = await resp.json();
                        xml = json.contents;
                    } else {
                        xml = await resp.text();
                    }

                    if (xml && xml.length > 100) {
                        articles = parseRSS(xml);
                        if (articles.length > 0) {
                            saveCache(articles);
                            updateStatus('loaded', 'Feed loaded via ' + proxy.name, articles.length);
                            updateRefreshButton();
                            buildTopicChips();
                            addBenMessage('Feed loaded with ' + articles.length + ' articles! Ask me anything about what Ben has been writing about.');
                            return;
                        }
                        errors.push(proxy.name + ': XML fetched but 0 articles parsed');
                    } else {
                        errors.push(proxy.name + ': empty/short response');
                    }
                } catch(e) {
                    errors.push(proxy.name + ': ' + (e.message || 'network error'));
                }
            }

            // Fallback: try direct fetch (works if CORS headers are present)
            try {
                updateStatus('loading', 'Trying direct fetch...');
                const resp = await fetch(feedUrl);
                if (resp.ok) {
                    const xml = await resp.text();
                    if (xml && xml.length > 100) {
                        articles = parseRSS(xml);
                        if (articles.length > 0) {
                            saveCache(articles);
                            updateStatus('loaded', 'Feed loaded directly', articles.length);
                            updateRefreshButton();
                            buildTopicChips();
                            addBenMessage('Feed loaded with ' + articles.length + ' articles! Ask me anything.');
                            return;
                        }
                    }
                }
                errors.push('direct: failed or empty');
            } catch(e) {
                errors.push('direct: ' + (e.message || 'blocked'));
            }

            // All methods failed
            updateStatus('empty', 'All fetch methods failed');
            refreshBtn.textContent = 'Retry';
            refreshBtn.disabled = false;

            let errorDetail = '<strong>Could not fetch the RSS feed.</strong> Tried ' + errors.length + ' methods, all failed:<br><br>';
            errorDetail += '<div style="font-size:0.85em;color:#ff8888;font-family:monospace;background:rgba(255,0,0,0.08);padding:10px;border-radius:6px;margin-bottom:10px;">';
            errors.forEach(function(e, i) { errorDetail += (i + 1) + '. ' + escapeHTML(e) + '<br>'; });
            errorDetail += '</div>';
            errorDetail += '<div style="font-size:0.85em;color:#aaa;">Feed URL: ' + escapeHTML(feedUrl) + '</div><br>';
            errorDetail += '<strong>Workaround:</strong> Open Settings, scroll down to "Manual Paste", open the RSS URL directly in your browser, copy the page source (Ctrl+U then Ctrl+A, Ctrl+C), and paste it in.';
            addBenMessage(errorDetail);
        };

        // --- Parse RSS2JSON format ---
        function parseRSS2JSON(json) {
            const parsed = [];
            (json.items || []).forEach(function(item) {
                const textContent = stripHTML(item.content || item.description || '');
                const descText = stripHTML(item.description || '');
                if (item.title || textContent) {
                    parsed.push({
                        title: item.title || 'Untitled',
                        description: descText.substring(0, 300),
                        content: textContent,
                        date: item.pubDate ? formatDate(item.pubDate) : '',
                        link: item.link || '',
                        categories: item.categories || [],
                        paragraphs: splitIntoParagraphs(textContent)
                    });
                }
            });
            return parsed;
        }

        // --- Load pasted XML ---
        window.loadPastedFeed = function() {
            const pasteArea = document.getElementById('pasteXml');
            const xml = pasteArea.value.trim();
            if (!xml) {
                addBenMessage('Please paste the RSS feed XML content first.');
                return;
            }

            articles = parseRSS(xml);
            if (articles.length === 0) {
                addBenMessage('Could not parse any articles from the pasted content. Make sure you copied the full XML source of the RSS feed (try Ctrl+U in the browser to view source, then copy all).');
                return;
            }

            saveCache(articles);
            updateStatus('loaded', 'Feed loaded from paste', articles.length);
            updateRefreshButton();
            buildTopicChips();
            setupPanel.classList.remove('visible');
            pasteArea.value = '';
            addBenMessage('Feed loaded with ' + articles.length + ' articles from pasted content! Ask me anything.');
        };

        // --- Parse RSS XML ---
        function parseRSS(xml) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                const items = doc.querySelectorAll('item');
                const parsed = [];

                items.forEach(function(item) {
                    const title = getTagText(item, 'title');
                    const description = getTagText(item, 'description');
                    const contentEncoded = getTagText(item, 'content\\:encoded') || getTagText(item, 'content:encoded');
                    const pubDate = getTagText(item, 'pubDate');
                    const link = getTagText(item, 'link');
                    const categories = [];
                    item.querySelectorAll('category').forEach(function(cat) {
                        categories.push(cat.textContent.trim());
                    });

                    // Get best available content, strip HTML
                    const rawContent = contentEncoded || description || '';
                    const textContent = stripHTML(rawContent);
                    const descText = stripHTML(description || '');

                    if (title || textContent) {
                        parsed.push({
                            title: title || 'Untitled',
                            description: descText.substring(0, 300),
                            content: textContent,
                            date: pubDate ? formatDate(pubDate) : '',
                            link: link || '',
                            categories: categories,
                            // Pre-compute paragraphs for search
                            paragraphs: splitIntoParagraphs(textContent)
                        });
                    }
                });

                return parsed;
            } catch(e) {
                return [];
            }
        }

        function getTagText(parent, tagName) {
            // Handle namespaced tags
            const el = parent.querySelector(tagName) || parent.getElementsByTagName(tagName)[0];
            if (!el) return '';
            return el.textContent || el.innerHTML || '';
        }

        function stripHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        function formatDate(dateStr) {
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch(e) {
                return dateStr;
            }
        }

        function splitIntoParagraphs(text) {
            return text.split(/\n\n+|\.\s+/)
                .map(function(p) { return p.trim(); })
                .filter(function(p) { return p.length > 40; });
        }

        // --- Search Engine ---
        function extractKeywords(query) {
            return query.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(function(w) { return w.length > 1 && !STOP_WORDS.has(w); });
        }

        function scoreParagraph(paragraph, keywords) {
            const lower = paragraph.toLowerCase();
            let score = 0;
            let matched = 0;

            keywords.forEach(function(kw) {
                const regex = new RegExp('\\b' + escapeRegex(kw) + '\\w*', 'gi');
                const matches = lower.match(regex);
                if (matches) {
                    score += matches.length;
                    matched++;
                }
            });

            // Bonus for matching more distinct keywords
            if (matched > 1) {
                score *= (1 + matched * 0.3);
            }

            // Slight penalty for very long paragraphs (prefer focused content)
            if (paragraph.length > 1000) {
                score *= 0.9;
            }

            return { score: score, matched: matched };
        }

        function escapeRegex(s) {
            return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function search(query) {
            if (articles.length === 0) return [];

            const keywords = extractKeywords(query);
            if (keywords.length === 0) return [];

            const results = [];

            articles.forEach(function(article) {
                // Score the title
                const titleScore = scoreParagraph(article.title, keywords);

                // Score each paragraph
                let bestPara = null;
                let bestParaScore = 0;

                article.paragraphs.forEach(function(para) {
                    const ps = scoreParagraph(para, keywords);
                    if (ps.score > bestParaScore) {
                        bestParaScore = ps.score;
                        bestPara = para;
                    }
                });

                // Also check description
                const descScore = scoreParagraph(article.description, keywords);

                const totalScore = (titleScore.score * 3) + bestParaScore + descScore.score;

                if (totalScore > 0) {
                    results.push({
                        article: article,
                        score: totalScore,
                        bestParagraph: bestPara || article.description,
                        titleMatch: titleScore.score > 0
                    });
                }
            });

            // Sort by score descending
            results.sort(function(a, b) { return b.score - a.score; });

            return results.slice(0, 5);
        }

        function highlightKeywords(text, query) {
            const keywords = extractKeywords(query);
            let result = escapeHTML(text);

            keywords.forEach(function(kw) {
                const regex = new RegExp('(' + escapeRegex(kw) + '\\w*)', 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });

            return result;
        }

        function escapeHTML(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        // --- Chat Messages ---
        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'chat-message user';
            div.innerHTML = '<div class="msg-sender">You</div><div class="msg-bubble">' + escapeHTML(text) + '</div>';
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addBenMessage(html) {
            const div = document.createElement('div');
            div.className = 'chat-message ben';
            div.innerHTML = '<div class="msg-sender">Stratechery Bot</div><div class="msg-bubble">' + html + '</div>';
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function formatSearchResult(result, query) {
            let excerpt = result.bestParagraph;
            // Trim to reasonable length
            if (excerpt.length > 500) {
                // Try to find the most relevant window
                const keywords = extractKeywords(query);
                let bestStart = 0;
                let bestCount = 0;
                const windowSize = 400;

                for (let i = 0; i < excerpt.length - windowSize; i += 50) {
                    const window = excerpt.substring(i, i + windowSize).toLowerCase();
                    let count = 0;
                    keywords.forEach(function(kw) {
                        const regex = new RegExp(escapeRegex(kw), 'gi');
                        const matches = window.match(regex);
                        if (matches) count += matches.length;
                    });
                    if (count > bestCount) {
                        bestCount = count;
                        bestStart = i;
                    }
                }

                const start = Math.max(0, bestStart);
                const end = Math.min(excerpt.length, start + windowSize);
                excerpt = (start > 0 ? '...' : '') + excerpt.substring(start, end) + (end < excerpt.length ? '...' : '');
            }

            const highlighted = highlightKeywords(excerpt, query);

            return '<div class="excerpt">' + highlighted + '</div>' +
                   '<div class="article-ref">' +
                   '<span class="article-title">' + escapeHTML(result.article.title) + '</span>' +
                   (result.article.date ? ' <span class="article-date">(' + escapeHTML(result.article.date) + ')</span>' : '') +
                   '</div>';
        }

        // --- Send Message ---
        window.sendMessage = function() {
            const text = chatInput.value.trim();
            if (!text) return;

            chatInput.value = '';
            addUserMessage(text);

            if (articles.length === 0) {
                addBenMessage('I don\'t have any articles loaded yet. Please load the RSS feed first using the Refresh button above, or set your feed URL in Settings.');
                return;
            }

            const results = search(text);

            if (results.length === 0) {
                addBenMessage('I couldn\'t find any articles matching that topic in the current feed. Try different keywords or browse the topics below.');
                return;
            }

            // Build response
            let response = '';

            if (results.length === 1) {
                response = 'Here\'s what I found on that topic:<br><br>';
                response += formatSearchResult(results[0], text);
            } else {
                response = 'I found <strong>' + results.length + ' relevant articles</strong>. Here are the most relevant passages:<br><br>';
                results.forEach(function(r, i) {
                    if (i > 0) response += '<br><br>';
                    response += formatSearchResult(r, text);
                });
            }

            addBenMessage(response);
        };

        window.askQuestion = function(text) {
            chatInput.value = text;
            sendMessage();
        };

        // --- Build dynamic topic chips based on article content ---
        function buildTopicChips() {
            // Count category/keyword frequency across articles
            const topicFreq = {};
            articles.forEach(function(a) {
                a.categories.forEach(function(cat) {
                    const key = cat.toLowerCase().trim();
                    if (key.length > 2 && key.length < 30) {
                        topicFreq[key] = (topicFreq[key] || 0) + 1;
                    }
                });
            });

            // Sort by frequency
            const sorted = Object.keys(topicFreq).sort(function(a, b) { return topicFreq[b] - topicFreq[a]; });
            const topTopics = sorted.slice(0, 6);

            if (topTopics.length > 0) {
                topicChips.innerHTML = '';
                topTopics.forEach(function(topic) {
                    const btn = document.createElement('button');
                    btn.className = 'topic-chip';
                    btn.textContent = topic;
                    btn.onclick = function() { askQuestion(topic); };
                    topicChips.appendChild(btn);
                });
            }
            // If no categories found, keep the default chips
        }

        // --- Boot ---
        init();
    })();
    </script>
</body>
</html>
